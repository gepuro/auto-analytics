# Auto Analytics システムアーキテクチャ設計書

## 1. システム概要

Auto Analyticsは、Google Agent Development Kit (ADK)とGemini 2.5 Flashを活用したマルチエージェントシステムです。自然言語での対話を通じてデータ分析を実行し、専門知識の有無に関わらず全社員がデータから洞察を得られる環境を提供します。

## 2. アーキテクチャ概要

### 2.1 システム構成図

```
┌─────────────────────────────────────────────────────────────┐
│                    Web Interface (ADK)                      │
│                   ユーザーインターフェース                      │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────┴───────────────────────────────────────┐
│               Agent Orchestrator                            │
│            メインエージェント（対話制御）                         │
└─────────────────────┬───────────────────────────────────────┘
                      │
        ┌─────────────┼─────────────┐
        │             │             │
┌───────▼────┐ ┌─────▼─────┐ ┌─────▼──────┐
│Natural Lang│ │Data Analyst│ │Report Gen  │
│ Processing │ │   Agent    │ │   Agent    │
│   Agent    │ │            │ │            │
└────────────┘ └─────┬─────┘ └────────────┘
                      │
              ┌───────▼───────┐
              │   MCP Server  │
              │ (Data Access) │
              └───────┬───────┘
                      │
              ┌───────▼───────┐
              │   Database    │
              │  (PostgreSQL) │
              └───────────────┘
```

### 2.2 技術スタック

#### フロントエンド
- **フレームワーク**: Google Agent Development Kit (ADK)
- **インターフェース**: Webベースの対話型UI
- **レンダリング**: ADKライブラリによるリアルタイムレスポンス

#### バックエンド
- **AIモデル**: Google Gemini 2.5 Flash
- **API統合**: Google AI Studio / Vertex AI
- **エージェントフレームワーク**: ADK Multi-Agent System
- **データアクセス**: MCP (Model Context Protocol) Server

#### データ層
- **データベース**: PostgreSQL（MCPサーバー経由でアクセス）
- **分析ライブラリ**: pandas, numpy, scipy
- **可視化**: matplotlib, plotly

## 3. マルチエージェントアーキテクチャ

### 3.1 エージェント構成

#### Agent Orchestrator（メインエージェント）
- **役割**: 全体の制御とエージェント間の協調
- **責務**: 
  - ユーザー要求の分析と適切なエージェントへの振り分け
  - エージェント間の情報共有とワークフロー管理
  - 結果の統合と最終レスポンスの生成

#### Natural Language Processing Agent
- **役割**: 自然言語理解と質問の明確化
- **責務**:
  - ユーザーの曖昧な質問の明確化
  - 文脈を考慮した対話の継続
  - 多言語対応（日本語・英語）
  - 分析要求の構造化

#### Data Analyst Agent
- **役割**: データ分析の実行
- **責務**:
  - SQLクエリの自動生成・最適化
  - Pythonコードによるデータ処理
  - 統計分析と機械学習
  - 結果の解釈と洞察の抽出

#### Report Generation Agent
- **役割**: レポート生成と可視化
- **責務**:
  - 分析結果の自動レポート化
  - グラフ・チャートの生成
  - HTML形式での出力
  - アクションアイテムの提案

### 3.2 エージェント間通信

```python
# エージェント間通信の概念図
class AgentCommunication:
    def __init__(self):
        self.shared_context = {}
        self.message_queue = []
    
    def send_message(self, from_agent, to_agent, message):
        # エージェント間メッセージング
        pass
    
    def update_context(self, agent_id, context_data):
        # 共有コンテキストの更新
        pass
```

## 4. データフロー設計

### 4.1 基本的なデータフロー

```
User Query → NLP Agent → Context Analysis → Data Analyst Agent
     ↓
SQL Generation → MCP Server → Database Query → Result Processing
     ↓
Analysis & Insights → Report Generation Agent → HTML Report → User
```

### 4.2 非決定論的アプローチ

- **探索的分析**: 初期仮説に基づく分析から派生する追加調査
- **動的クエリ生成**: 分析結果に基づく次のクエリの自動生成
- **仮説検証ループ**: データから仮説を生成し、検証を繰り返す

## 5. API統合設計

### 5.1 Gemini 2.5 Flash統合

```python
# Gemini API統合の概念設計
class GeminiIntegration:
    def __init__(self, api_key):
        self.api_key = api_key
        self.model = "gemini-2.5-flash"
    
    async def generate_response(self, prompt, context=None):
        # 構造化プロンプトによるレスポンス生成
        pass
    
    def optimize_prompt(self, agent_type, task):
        # エージェント専用プロンプトテンプレート
        pass
```

### 5.2 プロンプト最適化戦略

- **エージェント特化**: 各エージェントに最適化されたプロンプトテンプレート
- **構造化出力**: JSON、SQL等の確実な構造化レスポンス
- **コンテキスト管理**: 長期対話のためのコンテキスト保持機能
- **API使用量最適化**: 効率的なプロンプト設計によるコスト削減

## 6. MCP統合設計

### 6.1 MCPサーバーアーキテクチャ

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   ADK Agent     │───▶│   MCP Server    │───▶│   PostgreSQL    │
│                 │    │                 │    │                 │
│ - Query Gen     │    │ - Auth          │    │ - Data Storage  │
│ - Result Parse  │    │ - Query Exec    │    │ - Schema Mgmt   │
│ - Error Handle  │    │ - Security      │    │ - Performance   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 6.2 セキュリティレイヤー

- **認証・認可**: データアクセス権限の適切な管理
- **SQLインジェクション対策**: MCPサーバーレベルでの脅威防止
- **データマスキング**: 機密データの保護
- **アクセスログ**: 全てのデータアクセスの監査

## 7. 拡張性とメンテナンス性

### 7.1 モジュラー設計

- **エージェントの独立性**: 各エージェントは独立して開発・デプロイ可能
- **プラグインアーキテクチャ**: 新しい分析機能の追加が容易
- **設定駆動**: 設定ファイルによる動作のカスタマイズ

### 7.2 監視とログ

- **パフォーマンス監視**: API応答時間とシステムリソースの監視
- **エラートラッキング**: 包括的なエラーログとアラート機能
- **ユーザー行動分析**: 利用パターンの分析と改善点の特定

## 8. デプロイメント設計

### 8.1 開発環境

- **ローカル開発**: ADKの開発環境セットアップ
- **テスト環境**: 統合テスト用の独立環境
- **ステージング**: 本番前の最終検証環境

### 8.2 本番環境

- **高可用性**: エージェントの冗長化とフェイルオーバー
- **スケーラビリティ**: 負荷に応じた自動スケーリング
- **セキュリティ**: エンドツーエンドの暗号化と監査

## 9. 非機能要件の実現

### 9.1 性能要件

- **応答時間**: Gemini API応答時間3秒以内
- **同時接続**: 複数ユーザーの同時利用サポート
- **データ処理**: 大容量データセットの効率的な処理

### 9.2 品質要件

- **可用性**: 99.5%以上のシステム稼働率
- **信頼性**: データ整合性と分析結果の正確性
- **ユーザビリティ**: 直感的なインターフェースと学習コスト最小化