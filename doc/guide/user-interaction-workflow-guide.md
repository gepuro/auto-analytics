# ユーザー対話ワークフロー ガイド

## 概要

Auto Analytics AIエージェントシステムに、ユーザーからの詳細情報が必要かどうかを自動判断し、必要に応じて追加情報を求める機能が追加されました。

## 機能の特徴

### 1. 自動情報完全性チェック
- **情報不足検出エージェント**がユーザーのリクエストを分析
- 分析に必要な情報が不足している場合を自動検出
- 信頼度スコアに基づいて継続/確認の判断を実行

### 2. インテリジェントなユーザー質問生成
- **ユーザー確認エージェント**が具体的な質問を自動生成
- 選択肢付きの分かりやすい質問形式
- 複数の不明点を効率的に一度に確認

### 3. 動的ワークフロー制御
- 情報が十分な場合：そのまま分析実行
- 情報不足の場合：ユーザー確認後に分析実行
- **ワークフロー制御システム**による柔軟な分岐処理

## システム構成

```
ユーザーリクエスト
        ↓
[Request Interpreter] リクエスト解釈
        ↓
[Information Gap Detector] 情報完全性チェック
        ↓
    情報十分？ ←─┐
       ↓ Yes    │
[Schema Explorer] │ No
       ↓        │
   データ分析     │
       ↓        │
   HTMLレポート   │
                │
              ↓
[User Confirmation Agent] ユーザー質問生成
              ↓
          ユーザー回答待ち
              ↓
[User Input Handler] 回答統合
              ↓
          分析実行 ─┘
```

## 実装コンポーネント

### 1. 情報不足検出エージェント (`information_gap_detector`)

**役割**: 分析リクエストの情報完全性を評価

**評価基準**:
- 分析対象の明確性（必須）
- 時間軸・期間の指定（重要）
- 分析の粒度・レベル（重要）
- 比較・条件の有無（任意）
- 出力形式の期待（任意）

**出力形式**:
```json
{
  "status": "sufficient" | "needs_clarification",
  "confidence_score": 0.0-1.0,
  "missing_info": ["不足情報項目"],
  "ambiguous_points": ["曖昧な部分"],
  "analysis_feasibility": "評価コメント",
  "recommendation": "分析続行 | 追加情報要求"
}
```

### 2. ユーザー確認エージェント (`user_confirmation_agent`)

**役割**: ユーザーに追加情報を求める質問を生成

**質問項目**:
- 📅 **分析期間**: 今月、先月、今年、昨年、特定期間
- 📊 **分析粒度**: 日別、週別、月別、年別
- 🎯 **分析対象**: 全体、特定商品、特定地域、特定顧客層
- 📈 **比較軸**: 前年同期、前月、目標値、比較なし
- 📋 **出力形式**: グラフ、表、ランキング、サマリー

**出力例**:
```
分析のご依頼をいただき、ありがとうございます。

📊 **ご依頼の内容**: 売上データの分析

より正確で有用な分析を行うため、以下について教えていただけますでしょうか：

📅 **分析期間を教えてください**：
1. 今月（2024年1月）
2. 先月（2023年12月）
3. 今年度（2023年4月-2024年3月）
4. その他（具体的な期間をお教えください）

📊 **集計レベルを教えてください**：
1. 日別
2. 週別
3. 月別
4. 年別

これらの情報をお教えいただければ、詳細な分析レポートをお作りします。
```

### 3. ワークフロー制御システム (`workflow_controller.py`)

**機能**:
- 情報完全性の動的評価
- ユーザー質問の自動生成
- 回答統合とリクエスト完成
- ワークフロー状態管理

**主要メソッド**:
```python
# 情報完全性チェック
check_information_completeness_v2(gap_analysis_output)

# ユーザー質問生成
generate_user_questions(original_request, gap_analysis)

# 回答統合
integrate_user_feedback(original_request, questions, user_response)
```

## 使用方法

### 1. 基本的な流れ

1. **ユーザーがリクエスト送信**
   ```
   例: "売上データを分析してほしい"
   ```

2. **システムが自動判定**
   - 情報十分 → 即座に分析開始
   - 情報不足 → 確認質問を生成

3. **情報不足の場合**
   ```
   システム: "分析期間と集計レベルを教えてください"
   ユーザー: "先月の日別売上で"
   システム: "承知しました。先月の日別売上分析を開始します"
   ```

### 2. 十分な情報を含むリクエスト例

```
✅ 良い例:
"2023年12月の商品別売上推移を前年同月と比較したグラフを作成してください"

理由: 期間、対象、粒度、比較軸、出力形式がすべて明確
```

### 3. 情報不足のリクエスト例

```
❓ 不足例:
"売上を見たい"
"最近の業績を分析して"
"顧客データを調べてほしい"

理由: 期間、粒度、対象が不明確
```

## 設定とカスタマイズ

### 1. 評価基準の調整

`workflow_controller.py`の`_estimate_confidence_from_text`メソッドで信頼度判定を調整:

```python
confidence_keywords = {
    "確実": 0.9, "十分": 0.8, "問題なし": 0.8,
    "曖昧": 0.3, "不足": 0.2, "不明": 0.2
}
```

### 2. 質問テンプレートの修正

`workflow_controller.py`の`standard_questions`辞書で質問内容を変更:

```python
standard_questions = {
    "期間": "分析対象の期間を教えてください：...",
    "粒度": "データの集計レベルを教えてください：...",
    # カスタム質問を追加
}
```

### 3. エージェントの指示調整

各エージェントの`instruction`パラメータで動作を調整可能:
- `information_gap_detector`: 評価基準の変更
- `user_confirmation_agent`: 質問スタイルの変更

## トラブルシューティング

### 1. 情報十分なのに確認が求められる

**原因**: 信頼度スコアが低い
**対策**: `confidence_keywords`の調整 or 閾値の変更

### 2. 確認質問が適切でない

**原因**: 不足情報の抽出が不正確
**対策**: `_extract_missing_info_from_text`の改善

### 3. ワークフローが止まる

**原因**: エージェント間の連携エラー
**対策**: `workflow_controller.get_workflow_status()`で状態確認

## 今後の拡張予定

1. **多言語対応**: 英語での質問生成
2. **学習機能**: ユーザーの傾向学習
3. **高度な質問生成**: 文脈に応じたより具体的な質問
4. **自動補完**: 一般的なパターンの自動推定

## 関連ファイル

- `/workspace/auto-analytics-agent/workflow.py`: メインワークフロー
- `/workspace/auto-analytics-agent/workflow_controller.py`: 制御システム
- `/workspace/auto-analytics-agent/agent.py`: エージェント定義
- `/workspace/config/tools.yaml`: データベース接続設定

---

最終更新: 2024年1月21日